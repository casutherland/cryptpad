# About Sandstorm and this experimental 'sandstorm-soon' branch of CryptPad

[Sandstorm](https://sandstorm.io/) is an innovative platform for hosting, and easily self-hosting, instances of [documents and applications](https://apps.sandstorm.io/) (grains) from within a container dedicated to the individual grain.

The files within this .sandstorm folder are the first steps in an experiment to package CryptPad as a Sandstorm application.


# Prerequisites

Install [vagrant-spk](https://docs.sandstorm.io/en/latest/vagrant-spk/installation/) and review the Sandstorm [Packaging tutorial](https://docs.sandstorm.io/en/latest/vagrant-spk/packaging-tutorial/) to become familiar with the Sandstorm package development tools.


# Running CryptPad as a local Sandstorm application

Once you have installed [vagrant-spk](https://docs.sandstorm.io/en/latest/vagrant-spk/installation/)

```
git clone <this repo> crpytpad-sandstorm
cd ./cryptpad-sandstorm/
git checkout sandstorm-soon
vagrant-spk vm up
vagrant-spk dev
# open http://local.sandstorm.io:6080/ in your browser
```

# Known Issues / Roadmap

1. Reconcile with sandstorm's [use of ephemeral random per-session subdomains](https://docs.sandstorm.io/en/latest/developing/path/#overview-the-grain-url-grain-ephemeral-subdomains) and [requirement to pass the URL path and fragment through to the grain](https://docs.sandstorm.io/en/latest/developing/path/#navigating-to-paths-within-a-grain) embedded within the Sandstorm IFRAME.
    1. Expose a Sandstorm compatible "Persistent Secret URL" UI element (similar to the View Only URL), when Sandstorm is detected as the hosting platform.
      * See: [Updating the URL & page title from your app](https://docs.sandstorm.io/en/latest/developing/path/#updating-the-url-page-title-from-your-app)
      * The Ephemeral Secret URL generated by CryptPad when hosted in Sandstorm is currently:
          * http://{{sandstormGrainEphemeralSubDomain}}.local.sandstorm.io:6080/pad/#/1/edit/{{cryptpadDocSharedKey}}
      * The Persistent Secret URL format that is required to access a persistent CryptPad document:
          *  http://local.sandstorm.io:6080/grain/{{grainId}}>/pad/#/1/edit/{{cryptpadDocSharedKey}}
    1. Related: correct the View Only Persistent Secret URL format, when Sandstorm is detected as the hosting platform.
1. Test with HTTPS on a self-hosted sandstorm server or https://oasis.sandstorm.io/ (Note: no issues are anticipated under HTTPS.)
1. Create a pull request from the sandstorm feature branch.
1. Additional optional enhancements, to increase usability under Sandstorm:
    1. Limit each grain to the creation of a single CryptPad document. Use [Sandstorm Collections](https://sandstorm.io/news/2016-08-09-collections-app) to group a set of shared documents.
    1. Use the Sandstorm user's identity, instead of manually entering a nominal USER name for each document within the grain.


# Resolved Issues

1. The CryptPad client application now successfully connects to the grain's websocket service.
    1. The resolution was to switch sandstorm dev over to the CryptPad "soon" branch, per [ansuz's guidance](https://github.com/xwiki-labs/cryptpad/issues/48#issuecomment-253167197). This resolved the WebSocket issues experienced on master (circa early-Oct 2016).
1. Tested sharing using Sandstorm's identity management and grain sharing model.
    * Test results: Passed. There were no issues sharing access to the same grain.
    * Steps taken:
        1. First, shared the sandstorm grain invite sharing URL from Alice to Bob.
            * http://local.sandstorm.io:6080/shared/{{sandstormGrainSharingInviteURL}}
        1. Then, manually crafted the persistent URL using the sandstorm server base URL, sandstorm grainId, the cryptpad URL path (/pad/), and the cryptpad location.hash (#/1/edit/{{cryptpadDocSharedKey}}) -- and shared this from Alice to Bob via a "secure side channel.
            * Ephemeral session URL format: http://{{sandstormGrainEphemeralSubDomain}}.local.sandstorm.io:6080/pad/#/1/edit/{{cryptpadDocSharedKey}}
            * Persistent URL format: http://local.sandstorm.io:6080/grain/{{grainId}}>/pad/#/1/edit/{{cryptpadDocSharedKey}}
    * Aside: as an optional future enhancement: use the Sandstorm user's identity, instead of manually entering a nominal USER name for each document within the grain.
    * Dependency: still need to resolve the ephemeral subdomain and URL fragment / IFRAME issues affecting the creation of this URL.
    * Limitations:
        1. If Alice creates multiple CryptPad documents within the same grain, and creates a Persistent Secret URL for both documents, Bob will only have access to a single document within the grain at a time. Additionally, when Alice returns to the grain in a future session, using one of the Persistent Secret URLs, she will only have access to a single document within the grain at a time.
            * Recommendation: Limit each grain to the creation of a single CryptPad document. Use [Sandstorm Collections](https://sandstorm.io/news/2016-08-09-collections-app) to group a set of shared documents.
